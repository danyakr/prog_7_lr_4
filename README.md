# prog_7_lr_4

внешний вид за админа
<img width="1919" height="893" alt="image" src="https://github.com/user-attachments/assets/00e315fd-8f42-4a5b-901a-4741828d2323" />

создание новой формы
<img width="1682" height="914" alt="image" src="https://github.com/user-attachments/assets/0c71b7ad-39ab-41ec-8a22-efbfd18138e2" />

голосование 
<img width="1635" height="709" alt="image" src="https://github.com/user-attachments/assets/2ed7c871-de81-4d86-b6cd-69ad3f530cc1" />

регистрация
<img width="1470" height="912" alt="image" src="https://github.com/user-attachments/assets/59322b45-7f37-429f-ae25-ed3f31a83696" />


# Django Polls Application - "Polls from the Crypt"

Приложение для создания опросов на Django с аутентификацией пользователей, верификацией email и управлением опросами. В этой версии верификация email выводится в консоль разработчика.

## Содержание

- [Обзор проекта](#обзор-проекта)
- [Возможности](#возможности)
- [Структура проекта](#структура-проекта)
- [Установка](#установка)
- [Конфигурация](#конфигурация)
- [Email верификация](#email-верификация)
- [Использование](#использование)
- [Маршруты URL](#маршруты-url)
- [Админ-панель](#админ-панель)
- [Тестирование](#тестирование)

---

## Обзор проекта

"Polls from the Crypt" — это полнофункциональное приложение для опросов на Django, которое позволяет пользователям:
- Регистрироваться с верификацией email
- Просматривать и голосовать в опросах
- Создавать и редактировать опросы (только для staff пользователей)
- Управлять своими учётными записями с безопасным хранением паролей

Приложение использует встроенную систему аутентификации Django с пользовательской регистрацией и верификацией email.

---

## Возможности

### Аутентификация пользователей
- Регистрация с верификацией email
- Активация учётной записи через ссылку в письме
- Вход/выход из системы
- Управление доступом на основе ролей (staff пользователи могут создавать/редактировать опросы)
- Защищённое хранение паролей с использованием встроенной системы Django

### Управление опросами
- Создание новых опросов (только для staff)
- Редактирование существующих опросов (только для staff)
- Голосование в опросах
- Просмотр результатов опросов
- Отображение даты публикации опроса
- Фильтрация будущих/неопубликованных опросов

### Email верификация
- Вывод email в консоль во время разработки (не требует внешних сервисов)
- HTML шаблоны писем с ссылками активации
- Безопасная активация на основе токенов
- Обнаружение истекших ссылок
- Чёткая обратная связь для успешной/неудачной активации

### Пользовательский интерфейс
- Адаптивный дизайн с Bootstrap 5
- Красивые формы через Crispy Forms
- Навигация с отображением статуса аутентификации
- Система сообщений для обратной связи
- Индикаторы прав доступа для создания опросов

---

## Структура проекта

```
django_polls/
├── mysite/                          # Главный пакет проекта
│   ├── settings.py                  # Настройки проекта
│   ├── urls.py                      # Главные маршруты URL
│   ├── asgi.py
│   ├── wsgi.py
│   └── __init__.py
│
├── polls/                           # Приложение опросов
│   ├── migrations/                  # Миграции БД
│   ├── templates/polls/
│   │   ├── base.html               # Базовый шаблон
│   │   ├── index.html              # Список опросов
│   │   ├── detail.html             # Страница опроса
│   │   ├── results.html            # Результаты опроса
│   │   ├── login.html              # Форма входа
│   │   ├── register.html           # Форма регистрации
│   │   ├── poll_new_edit.html      # Создание/редактирование опроса
│   │   ├── account_activation_success.html
│   │   ├── account_activation_failure.html
│   │   └── verification_email.html # Шаблон письма верификации
│   │
│   ├── models.py                    # Модели (Question, Choice)
│   ├── views.py                     # Представления (Views)
│   ├── urls.py                      # URL маршруты приложения
│   ├── forms.py                     # Формы (QuestionForm, NewUserForm)
│   ├── admin.py                     # Настройка админ-панели
│   ├── apps.py
│   ├── tests.py
│   └── __init__.py
│
├── templates/
│   └── admin/
│       └── base_site.html           # Кастомизация админ-панели
│
├── manage.py                         # Утилита управления проектом
└── db.sqlite3                        # База данных (SQLite)
```

---

## Установка

### 1. Создание виртуального окружения

```bash
python -m venv .venv
.venv\Scripts\activate          # Windows
source .venv/bin/activate       # macOS/Linux
```

### 2. Установка зависимостей

```bash
pip install django
pip install django-crispy-forms
pip install crispy-bootstrap5
```

### 3. Применение миграций

```bash
python manage.py migrate
```

### 4. Создание суперпользователя

```bash
python manage.py createsuperuser
```

Укажите:
- Username: `admin`
- Email: `admin@example.com`
- Password: `your_secure_password`

### 5. Запуск сервера разработки

```bash
python manage.py runserver
```

Приложение будет доступно по адресу: `http://127.0.0.1:8000`

---

## Конфигурация

### settings.py - Ключевые настройки

```python
# Время и язык
LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'Europe/Moscow'
USE_I18N = True
USE_TZ = True

# Email (выводится в консоль)
EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'

# Crispy Forms
CRISPY_ALLOWED_TEMPLATE_PACKS = "bootstrap5"
CRISPY_TEMPLATE_PACK = "bootstrap5"

# Sites framework (для верификации)
SITE_ID = 1
```

### Использование консольного email бэкенда

Во время разработки письма отправляются в консоль сервера:

```
Content-Type: text/html; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Subject: Activate your Polls account
From: webmaster@localhost
To: user@example.com
Date: Thu, 16 Oct 2025 10:30:00 -0000
Message-ID: <xyz@localhost>

<html>
  <body>
    <h1>Активируйте вашу учётную запись</h1>
    <a href="http://127.0.0.1:8000/polls/activate/MjU/.../">
      Активировать аккаунт
    </a>
  </body>
</html>
```

Скопируйте ссылку активации из консоли и откройте её в браузере.

---

## Email верификация

### Процесс регистрации

1. **Пользователь регистрируется:**
   - Переходит на `/polls/register/`
   - Заполняет форму (username, email, password)
   - Нажимает "Register"

2. **Письмо отправляется в консоль:**
   - В консоли сервера появляется HTML письмо
   - Содержит ссылку активации с кодированным user ID и токеном

3. **Пользователь активирует аккаунт:**
   - Копирует ссылку из консоли
   - Открывает её в браузере
   - Получает подтверждение активации

4. **После активации:**
   - Пользователь может войти в систему
   - Доступны все функции приложения

### Формы верификации

**Успешная активация (`account_activation_success.html`):**
- Зелёный статус ✅
- Сообщение об успешной активации
- Кнопка перехода на форму входа

**Неудачная активация (`account_activation_failure.html`):**
- Красный статус ❌
- Причины сбоя (ссылка использована, истекла, скопирована неправильно)
- Кнопка для повторной регистрации

### Безопасность

- Используются встроенные токены Django (`default_token_generator`)
- URL-безопасное кодирование user ID (`urlsafe_base64_encode`)
- Проверка токена при активации
- Пользователь остаётся неактивным до подтверждения

---

## Использование

### Для обычных пользователей

#### Регистрация
1. Перейти на `/polls/register/`
2. Заполнить форму регистрации
3. Проверить консоль сервера на письмо активации
4. Скопировать ссылку и открыть её
5. Войти в систему на `/polls/login/`

#### Голосование
1. На главной странице `/polls/` видны доступные опросы
2. Кликнуть на опрос
3. Выбрать вариант ответа
4. Нажать "Vote"
5. Перенаправление на страницу результатов

#### Просмотр результатов
- Результаты доступны сразу после голосования
- Показываются все варианты с количеством голосов
- Кнопка для повторного голосования

### Для администраторов (staff пользователей)

#### Создание опроса
1. На главной странице нажать "➕ New Poll"
2. Заполнить текст вопроса
3. Ввести варианты ответов (каждый с новой строки)
4. Нажать "Save"
5. Опрос сразу становится доступным для голосования

#### Редактирование опроса
1. На странице опроса нажать "Edit" (видна только staff пользователям)
2. Изменить текст вопроса или варианты ответов
3. Нажать "Save"
4. Дата обновления устанавливается на текущее время

#### Доступ к админ-панели
1. Перейти на `/admin/`
2. Войти с учётными данными суперпользователя
3. Управлять опросами и пользователями

---

## Маршруты URL

| URL | Метод | Назначение | Доступ |
|-----|-------|-----------|--------|
| `/polls/` | GET | Список всех опросов | Все |
| `/polls/<id>/` | GET | Страница опроса для голосования | Все |
| `/polls/<id>/results/` | GET | Результаты опроса | Все |
| `/polls/<id>/vote/` | POST | Голосование в опросе | Все |
| `/polls/new/` | GET/POST | Создание опроса | Staff |
| `/polls/<id>/edit/` | GET/POST | Редактирование опроса | Staff |
| `/polls/login/` | GET/POST | Вход в систему | Все |
| `/polls/logout/` | GET | Выход из системы | Авторизованные |
| `/polls/register/` | GET/POST | Регистрация | Все |
| `/polls/activate/<uidb64>/<token>/` | GET | Активация аккаунта | Все |
| `/admin/` | GET/POST | Админ-панель | Суперпользователь |

---

## Скриншоты приложения

### Главная страница сайта для администраторов
![Главная страница для администраторов](https://github.com/user-attachments/assets/00e315fd-8f42-4a5b-901a-4741828d2323)

Главная страница приложения для авторизованного администратора. Отображает:
- Приветствие с именем пользователя
- Кнопку "➕ New Poll" для создания новых опросов
- Кнопку "Logout" для выхода из системы
- Список доступных опросов с датами публикации
- Кнопку "Edit" для редактирования каждого опроса (доступна только staff)
- Кнопку для переголосования

### Форма создания нового опроса
![Создание нового опроса](https://github.com/user-attachments/assets/0c71b7ad-39ab-41ec-8a22-efbfd18138e2)

Интерфейс для создания новых опросов. Доступна только для staff пользователей. Включает:
- Поле для текста вопроса
- Текстареа для ввода вариантов ответов (каждый с новой строки)
- Валидацию (минимум 2 варианта)
- Кнопки сохранения и отмены
- Подсказку по использованию

### Страница голосования
![Страница голосования](https://github.com/user-attachments/assets/2ed7c471-de81-4d86-b6cd-69ad3f530cc1)

Интерфейс для голосования в опросе. Пользователи могут:
- Видеть текст вопроса
- Выбирать один вариант из предложенных
- Видеть сообщения об ошибках (если вариант не выбран)
- Переходить обратно к списку опросов
- После голосования перенаправляются на страницу результатов

### Форма регистрации пользователя
![Регистрация пользователя](https://github.com/user-attachments/assets/59322b45-7f37-429f-ae25-ed3f31a83696)

Форма для создания новой учётной записи. Включает:
- Поле username (логин)
- Поле email адреса
- Поля пароля с подтверждением
- Валидацию пароля (сложность, подтверждение)
- Ссылку на форму входа для существующих пользователей
- После регистрации отправляется письмо верификации на консоль

---

## Админ-панель

### Доступ

```
Адрес: http://127.0.0.1:8000/admin/
Username: admin
Password: your_secure_password
```

### Возможности

#### Управление опросами
- **Список опросов:**
  - Отображает текст вопроса, дату публикации
  - Индикатор "Published recently?" (зелёная/красная иконка)
  - Сортировка по дате
  - Поиск по тексту вопроса

- **Создание/редактирование:**
  - Основная информация (текст вопроса)
  - Группированные fieldsets (можно сворачивать)
  - Inline редактирование вариантов ответов (ChoiceInline)

- **Удаление:**
  - Каскадное удаление связанных вариантов
  - Подтверждение перед удалением

#### Inline редактирование (ChoiceInline)
- Редактируйте варианты ответов прямо при редактировании вопроса
- 3 пустые строки для добавления новых вариантов
- Удаление вариантов флажком

### Кастомизация админ-панели

**Заголовок:**
- По умолчанию: "Django administration"
- Кастомный: "Polls Administration"
- Файл: `templates/admin/base_site.html`

**Список отображения:**
```python
list_display = ["question_text", "pub_date", "was_published_recently"]
```

**Фильтры:**
```python
list_filter = ["pub_date"]
```

**Поиск:**
```python
search_fields = ["question_text"]
```

---

## Тестирование

### Запуск тестов

```bash
python manage.py test polls
```

### Существующие тесты

**Тесты модели Question:**
- `test_was_published_recently_with_future_question` — будущие опросы не считаются недавними
- `test_was_published_recently_with_old_question` — старые опросы не считаются недавними
- `test_was_published_recently_with_recent_question` — опросы последних 24 часов считаются недавними

**Тесты представлений:**
- `test_no_questions` — главная страница пуста, если опросов нет
- `test_future_question` — будущие опросы возвращают 404
- `test_past_question` — прошлые опросы отображаются
- `test_future_question_and_past_question` — отображаются только прошлые опросы
- `test_two_past_questions` — отображаются несколько опросов в правильном порядке

### Примеры тестирования функциональности

```bash
# Консоль Django shell
python manage.py shell

# Создание тестовых данных
from polls.models import Question, Choice
from django.utils import timezone

q = Question.objects.create(
    question_text="What's your favorite color?",
    pub_date=timezone.now()
)

Choice.objects.create(question=q, choice_text="Red")
Choice.objects.create(question=q, choice_text="Blue")

# Проверка
print(q.choice_set.all())
```

---

## Модели данных

### Question (Вопрос)
```python
- question_text: CharField(200) — текст вопроса
- pub_date: DateTimeField — дата публикации
- was_published_recently(): bool — был ли опубликован в течение последних 24 часов
```

### Choice (Вариант ответа)
```python
- question: ForeignKey(Question) — связь с вопросом (каскадное удаление)
- choice_text: CharField(200) — текст варианта
- votes: IntegerField — количество голосов
```

---

## Формы

### QuestionForm
Форма для создания и редактирования опросов
- `question_text` — текст вопроса
- `choices` — варианты ответов (текстареа, разделённые переводом строки)

Валидация:
- Минимум 2 варианта ответа
- Удаление пробелов
- Сохранение старых вариантов перед созданием новых

### NewUserForm
Форма регистрации пользователя (наследует UserCreationForm)
- `username` — логин (уникальный)
- `email` — email адрес (обязательный)
- `password1` — пароль
- `password2` — подтверждение пароля

Автоматически:
- Отправляет письмо верификации
- Устанавливает `is_active = False` до активации

---

## Типичные ошибки и решения

### "Email не отправляется"
**Решение:** Письма выводятся в консоль сервера. Проверьте консоль, где запущен `python manage.py runserver`

### "Ссылка активации не работает"
**Решение:** Убедитесь, что скопировали ссылку полностью. Ссылка должна содержать:
```
/polls/activate/{uidb64}/{token}/
```

### "Пользователь не может войти после активации"
**Решение:** Убедитесь, что:
- Аккаунт активирован (страница "Account Activated!")
- Вводите правильные username и password
- Нет опечаток в данных

### "Опрос не появляется на главной странице"
**Решение:** Проверьте:
- Дата публикации не в будущем
- Опрос содержит минимум 2 варианта ответа
- Вы вошли в систему как staff пользователь для создания

---

## Полезные Django команды

```bash
# Создание миграций после изменения моделей
python manage.py makemigrations polls

# Просмотр SQL команд миграции (для обучения)
python manage.py sqlmigrate polls 0001

# Применение всех миграций
python manage.py migrate

# Интерактивная консоль Django
python manage.py shell

# Запуск тестов
python manage.py test polls

# Создание нового суперпользователя
python manage.py createsuperuser

# Чистка БД (удаление всех данных)
python manage.py flush
```

---

## Лицензия

Проект создан в образовательных целях в рамках лабораторной работы по Django.
